From 6c461dae53b557998b19b3c629cc0dfe865cbb48 Mon Sep 17 00:00:00 2001
From: xumia <xumia@microsoft.com>
Date: Mon, 8 Apr 2024 10:18:47 +0000
Subject: [PATCH] Support to enable SymCrypt provider by SONIC_FIPS in kernel

---
 crypto/context.c | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/crypto/context.c b/crypto/context.c
index dbeb881b45..cc2a363cca 100644
--- a/crypto/context.c
+++ b/crypto/context.c
@@ -23,6 +23,20 @@
 # include <unistd.h>
 # include <openssl/evp.h>
 
+extern int ossl_fips_enabled_by_cmd();
+extern int ossl_fips_enabled_by_conf();
+int oss_fips_enabled_check(){
+    if (ossl_fips_enabled_by_cmd() > 0){
+        return 1;
+    }
+
+    if (ossl_fips_enabled_by_conf() > 0){
+        return 1;
+    }
+
+    return 0;
+}
+
 # define FIPS_MODE_SWITCH_FILE "/proc/sys/crypto/fips_enabled"
 
 static int kernel_fips_flag;
@@ -39,7 +53,7 @@ static void read_kernel_fips_flag(void)
                close(fd);
        }
 
-       if (buf[0] == '1') {
+       if (buf[0] == '1' || oss_fips_enabled_check() > 0) {
                kernel_fips_flag = 1;
        }
 
-- 
2.39.2

